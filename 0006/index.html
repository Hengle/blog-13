<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Japanese Flash Card Prototype</title>

    <!-- Bootstrap -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/theme.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>Japanese Flash Card Prototype</h1>

    <div id="gameDiv">
    </div>

    <!--
    <div id="gameDiv">
        <h1 align="center">鏡</h1>
        <p align="center">Meaning</p>
        <p align="center">
            <input type="text" style="width: 200px; text-align: center">
        </p>
        <p align="center">
            <button style="width: 200px">Check!</button>
        </p>
    </div>

    <div id="gameDiv">
        <h1 align="center">鏡</h1>
        <p align="center">Meaning</p>
        <p align="center">
            <input type="text" style="width: 200px; text-align: center">
        </p>
        <p align="center">
            <button style="width: 200px">Check!</button>
        </p>
    </div>
    -->


    <div class="page-header"></div>
    <p>Last modified: 2017/06/21</p>
</div>

<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

<script src="wanakana.min.js"></script>

<script type="text/javascript">
    var data = [
        {
            "word": "鐘",
            "reading": "かね",
            "meaning": "bell",
            "examples": [
                "寺の[鐘]を聞きながら新年を迎える。"
            ]
        },
        {
            "word": "鈴",
            "reading": "すず",
            "meaning": "round bell",
            "examples": [
                "お土産に、綺麗な音の[鈴]を買った。"
            ]
        },
        {
            "word": "笛",
            "reading": "ふえ",
            "meaning": "flute",
            "examples": [
                "竹で作った[笛]を吹く。"
            ]
        },
        {
            "word": "網",
            "reading": "あみ",
            "meaning": "net",
            "examples": [
                "[網]で魚を捕る。"
            ]
        },
        {
            "word": "綱",
            "reading": "つな",
            "meaning": "thick rope",
            "examples": [
                "馬を[綱]でつなぐ。"
            ]
        },
        {
            "word": "縄",
            "reading": "なわ",
            "meaning": "thin rope",
            "examples": [
                "危険区域に[縄]を張り、立ち入り禁止にした。"
            ]
        },
        {
            "word": "鎖",
            "reading": "くさり",
            "meaning": "chain",
            "examples": [
                "綺麗な貝に[鎖]をつけてネックレスにした。"
            ]
        },
        {
            "word": "筒",
            "reading": "つつ",
            "meaning": "pipe, tube",
            "examples": [
                "竹の[筒]に花を生けた。"
            ]
        },
        {
            "word": "器",
            "reading": "うつわ",
            "meaning": "container",
            "examples": [
                "ガラスの[器]にサラダを盛る。"
            ]
        },
        {
            "word": "杯",
            "reading": "さかずき",
            "meaning": "sake cup",
            "examples": [
                "[杯]にたっぷり酒を注いだ。"
            ]
        },
        {
            "word": "柄",
            "reading": "え",
            "meaning": "handle",
            "examples": [
                "ナイフは[柄]の方を相手に向けて渡すものだ。"
            ]
        },
        {
            "word": "傘",
            "reading": "かさ",
            "meaning": "umbrella",
            "examples": [
                "電車の中の忘れ物では、[傘]が一番多い。"
            ]
        },
        {
            "word": "旗",
            "reading": "はた",
            "meaning": "flag",
            "examples": [
                "[旗]を振って選手を励ます。"
            ]
        },
        {
            "word": "鏡",
            "reading": "かがみ",
            "meaning": "mirror",
            "examples": [
                "大きな[鏡]に全身を映す。"
            ]
        },
        {
            "word": "棚",
            "reading": "たな",
            "meaning": "shelf",
            "examples": [
                "[棚]の上に箱を乗せる。"
            ]
        }
    ];

    function checkDataValidity(data) {
        if (!$.isArray(data)) {
            return "Data is not an array.";
        } else {
            var i;
            for (i = 0; i < data.length; i++) {
                var item = data[i];
                if (!item.hasOwnProperty("word")) {
                    return "The " + i + "th item does not have the 'word' field.";
                }
                if (!item.hasOwnProperty("reading")) {
                    return "The " + i + "th item does not have the 'reading' field.";
                }
                if (!wanakana.isHiragana(item.reading)) {
                    return "The " + i + "th item's reading is not Hiragana.";
                }
                if (!item.hasOwnProperty("meaning")) {
                    return "The " + i + "th item does not have the 'meaning' field.";
                }
            }
            return "valid";
        }
    }

    function decomposeToWordSequence(s) {
        return s.split(/\s+/);
    }

    function decomposeMeaningString(meaningString) {
        var meanings = meaningString.split(/[,\;]/);
        meanings = meanings.map(function (x) {
            return decomposeToWordSequence($.trim(x)).map(function (y) {
                return y.toLowerCase();
            });
        });
        return meanings;
    }

    function arraysEqual(a, b) {
        if (a === b) return true;
        if (a == null || b == null) return false;
        if (a.length != b.length) return false;

        for (var i = 0; i < a.length; ++i) {
            if (a[i] !== b[i]) return false;
        }
        return true;
    }

    function checkAnswerAgainstMeaning(answer, meaningString) {
        var answerSequence = decomposeToWordSequence(answer);
        var meanings = decomposeMeaningString(meaningString);
        var found = false;
        var i;
        for (i = 0; i < meanings.length; i++) {
            var meaning = meanings[i];
            if (arraysEqual(answerSequence, meaning)) {
                found = true;
                break;
            }
        }
        return found;
    }

    function randInt(n) {
        return Math.floor(Math.random() * n)
    }

    function chooseRandomItem(data) {
        return data[randInt(data.length)];
    }

    function newCard(currentItem) {
        var item = null;
        while (true) {
            item = chooseRandomItem(data);
            if (item !== currentItem) {
                break;
            }
        }
        var gameDiv = $("#gameDiv");
        var question;
        var choice = randInt(2);
        if (choice === 0) {
            question = new ReadingCard(item, gameDiv, null, null, newCard);
        } else {
            question = new MeaningCard(item, gameDiv, null, null, newCard);
        }

        question.run();
    }

    function Card(item, gameDiv, correctCallBack, wrongCallBack, nextCallBack) {
        this.item = item;
        this.gameDiv = gameDiv;
        this.correctCallBack = correctCallBack;
        this.wrongCallBack = wrongCallBack;
        this.nextCallBack = nextCallBack;
    }
    Card.prototype = {
        constructor: Card,
        html: function () {
            return "";
        },
        run: function () {
            var thou = this;
            this.gameDiv.html(this.html());

            var showButton = $("#showButton");
            showButton.click(function () {
                thou.showAnswer();
            });
            showButton.focus();

            $(window).off("keypress");
        },
        displayAnswer: function() {
            // NO-OP
        },
        showAnswer: function () {
            var thou = this;

            this.displayAnswer();

            var buttonRow = $("#buttonRow");
            buttonRow.html(
                "<td id='correctCell' width='50%' style='border: none' align='center'>" +
                "<button style='width: 100%' class='btn btn-danger' id='wrongButton'>&#10008; Too bad!</button>" +
                "</td>" +
                "<td id='correctCell' width='50%' style='border: none' align='center'>" +
                "<button style='width: 100%' class='btn btn-success' id='correctButton'>&#10003; Got it!</button>" +
                "</td>"
            );

            var correctButton = $("#correctButton");
            var correctFunc = function () {
                if (thou.correctCallBack !== null) {
                    thou.correctCallBack(this.item);
                }
                thou.nextCallBack(this.item);
            };
            correctButton.click(correctFunc);

            var wrongButton = $("#wrongButton");
            var wrongFunc = function () {
                if (thou.wrongCallBack !== null) {
                    thou.wrongCallBack(this.item)
                }
                thou.nextCallBack(this.item);
            };
            wrongButton.click(wrongFunc);

            $(window).keypress(function (event) {
                if (event.key === "Enter" || event.key === "Space" || event.key === "2") {
                    correctFunc();
                } else if (event.key === "Escape" || event.key === "Backspace" || event.key === "1") {
                    wrongFunc();
                }
            });
        }
    };

    function ReadingCard(item, gameDiv, correctCallBack, wrongCallBack, nextCallBack) {
        Card.call(this, item, gameDiv, correctCallBack, wrongCallBack, nextCallBack);
    }
    ReadingCard.prototype = Object.create(Card.prototype);
    ReadingCard.prototype.constructor = ReadingCard;
    ReadingCard.prototype.displayAnswer = function() {
        var readingButton = $("#readingButton");
        readingButton.html(this.item.reading);
    };
    ReadingCard.prototype.html = function() {
        return "<table class='table'>" +
            "<tr><td colspan='2' id='wordCell'><h1 align='center'>" + this.item.word + "</h1></td></tr>" +
            "<tr><td colspan='2' id='readingCell' style='border: none' align='center'>" +
            "<button style='width: 100%' class='btn btn-default' id='readingButton'>Reading = ???</button>" +
            "</td></tr>" +
            "<tr><td colspan='2' id='meaningCell' style='border: none' align='center'>" + this.item.meaning + "</td></tr>" +
            "<tr id='buttonRow'>" +
            "<td style='border: none' align='center'>" +
            "<button class='btn btn-primary' style='width: 100%' id='showButton'>Show answer...</button>" +
            "</td>" +
            "</tr>" +
            "</table>";
    };

    function MeaningCard(item, gameDiv, correctCallBack, wrongCallBack, nextCallBack) {
        Card.call(this, item, gameDiv, correctCallBack, wrongCallBack, nextCallBack);
    }
    MeaningCard.prototype = Object.create(Card.prototype);
    MeaningCard.prototype.constructor = MeaningCard;
    MeaningCard.prototype.displayAnswer = function() {
        var meaningButton = $("#meaningButton");
        meaningButton.html(this.item.meaning);
    };
    MeaningCard.prototype.html = function() {
        return "<table class='table'>" +
            "<tr><td colspan='2' id='wordCell'><h1 align='center'>" + this.item.word + "</h1></td></tr>" +
            "<tr><td colspan='2' id='readingCell' style='border: none' align='center'>" + this.item.reading + "</td></tr>" +
            "<tr><td colspan='2' id='meaningCell' style='border: none' align='center'>" +
            "<button style='width: 100%' class='btn btn-default' id='meaningButton'>Meaning = ???</button>" +
            "</td></tr>" +
            "<tr id='buttonRow'>" +
            "<td style='border: none' align='center'>" +
            "<button class='btn btn-active' style='width: 100%' id='showButton'>Show answer...</button>" +
            "</td>" +
            "</tr>" +
            "</table>";
    };

    var message = checkDataValidity(data);
    if (message == "valid") {
        newCard(null);
    } else {
        $("#gameDiv").html(message);
    }

</script>

<!-- Google Code Prettifier -->
<!-- <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script> -->
</body>
</html>